{"version":3,"sources":["../src/AppStores.jsx"],"names":["AppStores","stores","getStoreState","storeName","states","dispatch","type","state","preStates","listeners","forEach","dispatchListeners","l","push","length","merge","setStoreState","keys","connectors","connector","update","connects","intersection","handle","addDispatchListener","listener","key","uniqueId","removeDispatchListener","storestate","k","addStore","store","actionFactory","actions","getState","value","delStore"],"mappings":"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","file":"AppStores.js","sourcesContent":["import _ from 'lodash'\n\nclass AppStores {\n  constructor({ stores }) {\n    this.stores = stores || {}\n    this.connectors = {}  // 所有连接器\n    this.states = {} // 所有状态\n    this.actions = {} // 所有动作\n    this.dispatchListeners = {} // 分发事件监听器\n\n     // 初始化states和actions\n    _.forEach(stores, (store, storeName) => {\n      this.addStore(storeName, store)\n    })\n  }\n  getStoreState = (storeName) => this.states[storeName]\n  dispatch = (storeName, { type, state }) => {\n    const preStates = {}\n    const listeners = []\n    _.forEach(this.dispatchListeners, (l) => {\n      if (l.storeName === storeName && l.type === type) {\n        listeners.push(l)\n      }\n    })\n    if (listeners.length > 0) {\n      _.merge(preStates, this.states)\n    }\n    this.setStoreState(storeName, state)\n\n    // 更新状态到连接器中\n    const keys = _.keys(state)\n    _.forEach(this.connectors, (connector) => {\n      const { update, connects } = connector\n      // 如果该连接器的连接列表中，有当前storeName且\n      if (_.intersection(connects[storeName], keys).length > 0) {\n        update()\n      }\n    })\n\n    // 回调函数\n    if (listeners.length) {\n      _.forEach(listeners, (l) => {\n        l.handle({ type, storeName, preStates, states: this.states })\n      })\n    }\n  }\n  addDispatchListener = (listener) => {\n    const key = _.uniqueId('listener_')\n    this.dispatchListeners[key] = listener\n    return key\n  }\n  removeDispatchListener = (key) => {\n    if (this.dispatchListeners[key]) {\n      delete this.dispatchListeners[key]\n    }\n  }\n  setStoreState = (storeName, state) => {\n    const storestate = this.states[storeName]\n    if (storestate) {\n      const keys = _.keys(state)\n      _.forEach(keys, (k) => {\n        storestate[k] = state[k]\n      })\n    }\n  }\n  addStore = (storeName, store) => {\n    this.stores[storeName] = store\n\n    const { state, actionFactory } = store\n    // 初始化states\n    this.states[storeName] = {}\n    _.merge(this.states[storeName], state)\n    // 初始化actions\n    this.actions[storeName] = {}\n    _.merge(this.actions[storeName], actionFactory({\n      getState: () => this.getStoreState(storeName),\n      dispatch: (value) => this.dispatch(storeName, value),\n    }))\n  }\n  delStore = (storeName) => {\n    if (this.states[storeName]) {\n      delete this.states[storeName]\n    }\n    if (this.states[storeName]) {\n      delete this.states[storeName]\n    }\n    if (this.actions[storeName]) {\n      delete this.actions[storeName]\n    }\n  }\n}\n\nexport default AppStores\n"]}